version: "3.8"

services:
  # ═══════════════════════════════════════════════════════════
  # 🗄️ DATABASES - One per service
  # ═══════════════════════════════════════════════════════════

  # Product Database
  product-db:
    container_name: product-db
    image: postgres:15-alpine
    restart: unless-stopped
    volumes:
      - product_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=12345678
      - POSTGRES_DB=product-db
    ports:
      - "5434:5432"
    networks:
      - product-network

  # ═══════════════════════════════════════════════════════════
  # 🚪 GATEWAY - Using unified Dockerfile
  # ═══════════════════════════════════════════════════════════
  gateway:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_PATH: gateway
    container_name: gateway
    restart: unless-stopped
    ports:
      - "8080:8080"
    env_file:
      - gateway/.env
    networks:
      - public-network
      - microservices-network
  # ═══════════════════════════════════════════════════════════
  # 📦 MICROSERVICES - Using unified Dockerfile
  # ═══════════════════════════════════════════════════════════

  # 🛍️ Product Service + Product DB
  product-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_PATH: services/product
    container_name: product-service
    restart: unless-stopped
    expose:
      - "8081"
    environment:
      - DB_HOST=product-db
      - DB_NAME=product-db
      - GATEWAY_GRPC_ADDRESS=gateway:9090
      - SERVICE_HOST=product-service
    env_file:
      - services/product/.env
    networks:
      - microservices-network
      - product-network

# ═══════════════════════════════════════════════════════════
# 🌐 NETWORKS - Isolated per service + shared communication
# ═══════════════════════════════════════════════════════════
networks:
  public-network:
    driver: bridge

  microservices-network:
    driver: bridge

  product-network:
    driver: bridge
    internal: true

# ═══════════════════════════════════════════════════════════
# 💾 VOLUMES - Separated per database
# ═══════════════════════════════════════════════════════════
volumes:
  product_data:
    driver: local
